<template>
  <div class="page-wrapper">
    <div class="main-container">

      <div class="page-header">
        <router-link to="/home" class="back-button">
          â† è¿”å›ä¸»é¡µ
        </router-link>
        <h1 class="main-title">
          <span class="title-icon">ğŸ’</span>
          å¾®ç›˜è‚¡ç­–ç•¥
        </h1>
        <p class="subtitle">
          ç”¨é‡åŒ–çºªå¾‹è¿½è¸ªæŒ‡æ•°ï¼Œæ•æ‰å¸‚åœºæ·±å¤„çš„è§„æ¨¡å› å­ã€‚
        </p>
      </div>

      <div class="content-grid">

        <div class="content-card risk-warning-card">
          <h2 class="card-title">æç«¯é£é™©è­¦å‘Š</h2>
          <p class="card-description">
            å¾®ç›˜è‚¡ç­–ç•¥æ˜¯æ‰€æœ‰ç­–ç•¥ä¸­é£é™©ç­‰çº§æœ€é«˜çš„ã€‚è¯¥ç­–ç•¥æ‰€è¿½è¸ªçš„æŒ‡æ•°æˆåˆ†è‚¡æ™®éè§„æ¨¡å°ã€åŸºæœ¬é¢ä¸ç¡®å®šæ€§å¼ºï¼Œå¯¼è‡´æ•´ä½“æ³¢åŠ¨æä¸ºå‰§çƒˆï¼Œå¯èƒ½åœ¨çŸ­æœŸå†…å‡ºç°è¶…è¿‡50%ç”šè‡³æ›´å¤šçš„å‡€å€¼å›æ’¤ã€‚
            åŒæ—¶ï¼Œæˆåˆ†è‚¡çš„æµåŠ¨æ€§é£é™©å¯èƒ½ä¼ å¯¼è‡³ç­–ç•¥æœ¬èº«ã€‚<strong>æœ¬ç­–ç•¥åªé€‚åˆé£é™©æ‰¿å—èƒ½åŠ›æå¼ºçš„æŠ•èµ„è€…ï¼Œä¸”æŠ•å…¥èµ„é‡‘å¿…é¡»æ˜¯å®Œå…¨å¯ä»¥æ‰¿å—æŸå¤±çš„é—²é’±ã€‚</strong>
          </p>
        </div>

        <div class="content-card">
          <h2 class="card-title">ç»„åˆæ€æƒ³ï¼šé‡åŒ–è¿½è¸ªï¼Œçºªå¾‹æ‰§è¡Œ</h2>
          <p class="card-description">
            æœ¬ç­–ç•¥å¹¶éä¸»åŠ¨æŒ–æ˜ä¸ªè‚¡ï¼Œè€Œæ˜¯é€šè¿‡é‡åŒ–æ¨¡å‹ç´§å¯†è¿½è¸ª<b>ä¸‡å¾—å¾®ç›˜è‚¡æŒ‡æ•°</b>ï¼Œæ—¨åœ¨ç³»ç»Ÿæ€§åœ°æ•è·Aè‚¡å¸‚åœºçš„â€œè§„æ¨¡å› å­â€æº¢ä»·ã€‚
          </p>
          <ul class="idea-list">
            <li><b>è§„æ¨¡å› å­æº¢ä»·ï¼š</b> å­¦æœ¯ä¸å†å²æ•°æ®å‡è¡¨æ˜ï¼Œé•¿æœŸæ¥çœ‹ï¼Œå°å¸‚å€¼å…¬å¸çš„æ•´ä½“å›æŠ¥ç‡å€¾å‘äºè¶…è¶Šå¤§å¸‚å€¼å…¬å¸ã€‚æœ¬ç­–ç•¥çš„ç›®æ ‡æ­£æ˜¯æ•è·è¿™ç§ç”±â€œè§„æ¨¡â€è¿™ä¸€å› å­æœ¬èº«å¸¦æ¥çš„ç³»ç»Ÿæ€§è¶…é¢æ”¶ç›Šã€‚</li>
            <li><b>æ¯å‘¨åŠ¨æ€å†å¹³è¡¡ï¼š</b> æ¨¡å‹äº<b>æ¯å‘¨ä¸€</b>è¿›è¡Œè°ƒä»“ã€‚è¿™ç§å†å¹³è¡¡æœºåˆ¶ï¼Œç¡®ä¿äº†ç­–ç•¥èƒ½ç´§å¯†è·ŸéšæŒ‡æ•°çš„æˆåˆ†å˜åŒ–ï¼Œå¹¶åŠæ—¶æ•æ‰å¸‚åœºåŠ¨é‡ï¼Œæ˜¯ç­–ç•¥è·å–é˜¿å°”æ³•æ”¶ç›Šçš„å…³é”®ç¯èŠ‚ã€‚</li>
            <li><b>ä½œä¸ºâ€œå«æ˜Ÿâ€é…ç½®ï¼š</b> é‰´äºå¾®ç›˜è‚¡çš„é«˜æ³¢åŠ¨ç‰¹æ€§ï¼Œå®ƒé€‚åˆä½œä¸ºæŠ•èµ„ç»„åˆä¸­çš„â€œå«æ˜Ÿâ€éƒ¨åˆ†ï¼Œç”¨ä»¥å¢å¼ºæ•´ä½“æ”¶ç›Šå¼¹æ€§ã€‚å»ºè®®é…ç½®æ¯”ä¾‹ä¸è¶…è¿‡æ€»æŠ•èµ„èµ„äº§çš„20%ï¼Œå¹¶åšå¥½é•¿æœŸæŒæœ‰çš„å‡†å¤‡ã€‚</li>
          </ul>
        </div>
        <div class="content-card">
          <h2 class="card-title">æœ€æ–°æŒä»“ä¸è°ƒä»“å»ºè®®</h2>
          <p class="card-description">
            æ ¹æ®æ¨¡å‹äº {{ formattedDate }} ç”Ÿæˆçš„æœ€æ–°ç»„åˆã€‚
          </p>
          <div class="calculator-toolbar">
            <div class="calc-left">
              <div class="input-wrapper">
                <span class="currency-symbol">Â¥</span>
                <input type="number" v-model="inputAmount" class="compact-input" placeholder="è®¡åˆ’æŠ•å…¥" @keyup.enter="handleCalculate" />
              </div>
              <button class="calc-btn-compact" @click="handleCalculate">
                è®¡ç®—
              </button>
              <button class="calc-btn-compact outline" @click="openHoldingsModal">
                æˆ‘çš„æŒä»“
              </button>
            </div>

            <div v-if="hasCalculated" class="calc-right-group">

              <div class="stats-row">
                <div class="summary-tag">
                  <span class="label">è®¡åˆ’ä¹°å…¥</span>
                  <span class="value highlight">{{ calcSummary.totalPlanned.toFixed(0) }}</span>
                </div>
                <div class="summary-tag">
                  <span class="label">åˆ©ç”¨ç‡</span>
                  <span class="value" :class="{'warn': parseFloat(calcSummary.utilization) < 95}">
                    {{ calcSummary.utilization }}
                  </span>
                </div>
                <div class="summary-tag">
                  <span class="label">ç»“ä½™</span>
                  <span class="value">{{ (Number(inputAmount) - calcSummary.totalPlanned).toFixed(0) }}</span>
                </div>
              </div>

              <button class="apply-result-btn" @click="requestApplyPlan">
                å½•å…¥æ­¤ç»“æœ
              </button>
            </div>
          </div>

          <h3 class="card-subtitle">æ ¸å¿ƒæŒä»“å±•ç¤º (10åª)</h3>
          <div class="table-wrapper">
            <table class="data-table portfolio-table">
              <thead>
                <tr>
                  <th>ä»£ç </th>
                  <th>åç§°</th>
                  <th>ç°ä»·</th>
                  <th v-if="hasCalculated" class="calc-col-head">å»ºè®®æ‰‹æ•°</th>
                  <th v-if="hasCalculated" class="calc-col-head">è®¡åˆ’é‡‘é¢</th>
                  <th v-if="hasCalculated" class="calc-col-head">å æ¯”</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in latestPortfolio" :key="item.code">
                  <td class="code-font">{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.price.toFixed(2) }}</td>

                  <template v-if="hasCalculated">
                    <td class="calc-col-cell">
                      <span class="calc-val">{{ allocationData.get(item.code)?.shares || 0 }}</span>
                    </td>
                    <td class="calc-col-cell">
                      <span class="calc-val">{{ allocationData.get(item.code)?.cost.toFixed(0) || 0 }}</span>
                    </td>
                    <td class="calc-col-cell">
                      <span class="calc-val">{{ allocationData.get(item.code)?.weight || '0%' }}</span>
                    </td>
                  </template>
                </tr>
              </tbody>
            </table>
          </div>

          <template v-if="hasCalculated">
            <h3 class="card-subtitle" style="margin-top: 2rem;">ç»„åˆè°ƒä»“æŒ‡å¼•</h3>
            <div class="adjustments-grid">
              <div class="adjustment-block">
                <h4 class="adjustment-title sell">â¬‡ï¸ å»ºè®®è°ƒå‡º</h4>
                <ul class="adjustment-list">
                  <li v-for="item in sellList" :key="item.code" class="adjustment-item">
                    <div class="item-left">
                      <span class="stock-name">{{ item.name }}</span>
                      <span class="code-tiny">{{ item.code }}</span>
                    </div>
                    <div class="adj-right">
                      <span v-if="item.shares" class="shares-badge">{{ item.shares }}è‚¡</span>
                      <span class="action-badge" :class="item.subType">{{ item.action }}</span>
                    </div>
                  </li>
                  <li v-if="sellList.length == 0" class="adjustment-item-empty">ä»Šæ—¥æ— è°ƒå‡ºå»ºè®®</li>
                </ul>
              </div>

              <div class="adjustment-block">
                <h4 class="adjustment-title buy">â¬†ï¸ å»ºè®®è°ƒå…¥</h4>
                <ul class="adjustment-list">
                  <li v-for="item in buyList" :key="item.code" class="adjustment-item">
                    <div class="item-left">
                      <span class="stock-name">{{ item.name }}</span>
                      <span class="code-tiny">{{ item.code }}</span>
                    </div>
                    <div class="adj-right">
                      <span v-if="item.shares" class="shares-badge">{{ item.shares }}è‚¡</span>
                      <span class="action-badge" :class="item.subType">{{ item.action }}</span>
                    </div>
                  </li>
                  <li v-if="buyList.length === 0" class="adjustment-item-empty">ä»Šæ—¥æ— è°ƒå…¥å»ºè®®</li>
                </ul>
              </div>
            </div>
          </template>

        </div>

        <div class="content-card">
          <div class="card-header-row">
            <h2 class="card-title no-margin">å¾®ç›˜è‚¡ç­–ç•¥ vs æ²ªæ·±300å…¨æ”¶ç›Š</h2>
            <span class="period-badge">å›æµ‹å‘¨æœŸ: 2013-01-04 è‡³ 2025-12-31</span>
          </div>

          <div ref="chartContainer" class="echart-container"></div>

          <div class="stats-bar">
            <div class="stat-item">
              <div class="stat-label">æ€»æ”¶ç›Š</div>
              <div class="stat-value highlight">45341.53%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å¹´åŒ–æ”¶ç›Š</div>
              <div class="stat-value">62.35%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æ³¢åŠ¨ç‡</div>
              <div class="stat-value">28.91%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å¤æ™®æ¯”ç‡</div>
              <div class="stat-value">2.087</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœ€å¤§å›æ’¤</div>
              <div class="stat-value negative">-50.92%</div>
            </div>
          </div>
        </div>

        <div class="content-card">
          <h2 class="card-title">ç­–ç•¥æœˆåº¦/å¹´åº¦æ”¶ç›Šè¡¨</h2>
          <div class="table-container heatmap-container">
            <table class="heatmap-table">
              <thead>
                <tr>
                  <th>å¹´ä»½</th>
                  <th v-for="m in 12" :key="m">{{ m }}æœˆ</th>
                  <th>å¹´åº¦</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="yearData in monthlyReturns" :key="yearData.year">
                  <td class="year-col">{{ yearData.year }}</td>
                  <td v-for="(val, idx) in yearData.months" :key="idx" :style="getHeatmapStyle(val)" class="cell-val">
                    {{ val !== null ? val + '%' : '' }}
                  </td>
                  <td class="year-total" :style="getHeatmapStyle(yearData.total)">
                    {{ yearData.total }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="content-card">
          <h2 class="card-title">æ·±åº¦é£é™©åˆ†æ</h2>

          <div class="risk-summary-grid">
            <div class="risk-box">
              <div class="risk-label">å¡ç›æ¯”ç‡ (Calmar)</div>
              <div class="risk-main-val">1.224</div>
              <div class="risk-sub-val">å¹´åŒ–æ”¶ç›Š / æœ€å¤§å›æ’¤</div>
            </div>
            <div class="risk-box">
              <div class="risk-label"> æœˆåº¦èƒœç‡: 69.2%</div>
              <div class="risk-main-val">108 / 156</div>
              <div class="risk-sub-val">ç›ˆåˆ©æœˆæ•° / æ€»æœˆæ•°</div>
            </div>
            <div class="risk-box">
              <div class="risk-label">ç›ˆäºæ¯”</div>
              <div class="risk-main-val">0.928</div>
              <div class="risk-sub-val">æ—¥å‡ç›ˆåˆ© / æ—¥å‡äºæŸ</div>
            </div>
          </div>

          <h3 class="card-subtitle no-border">å›æ’¤æ·±åº¦åˆ†å¸ƒ (é¢‘ç‡ç»Ÿè®¡)</h3>
          <div class="table-container dist-table-container">
            <div class="dist-table-inner">
              <div class="dist-header-row">
                <div class="dist-col" v-for="item in drawdownDist" :key="item.range">{{ item.range }}</div>
              </div>
              <div class="dist-bar-row">
                <div class="dist-col" v-for="item in drawdownDist" :key="item.range">
                  <div class="dist-block yellow-theme" :style="{ opacity: item.count > 0 ? 1 : 0.6 }">
                    {{ item.count }}
                  </div>
                </div>
              </div>
              <div class="dist-label-row">
                <div class="dist-col">æ¬¡æ•°</div>
              </div>
            </div>
          </div>

          <h3 class="card-subtitle no-border" style="margin-top: 2rem;">å†å²é‡å¤§å›æ’¤æ˜ç»† (Top 10)</h3>
          <div class="table-wrapper">
            <table class="data-table risk-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>å¼€å§‹æ—¥æœŸ</th>
                  <th>è°·åº•æ—¥æœŸ</th>
                  <th>æ¢å¤æ—¥æœŸ</th>
                  <th>æœ€å¤§å›æ’¤</th>
                  <th>å›æ’¤æœŸ(å¤©)</th>
                  <th>ä¿®å¤æœŸ(å¤©)</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in topDrawdowns" :key="index">
                  <td>{{ index + 1 }}</td>
                  <td>{{ item.startDate }}</td>
                  <td>{{ item.troughDate }}</td>
                  <td>{{ item.endDate }}</td>
                  <td>{{ item.drawdown }}%</td>
                  <td>{{ item.ddDays }}</td>
                  <td>{{ item.fixDays }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="content-card">
          <h2 class="card-title">å¸¸è§é—®é¢˜ (FAQ)</h2>
          <div class="faq-container">
            <div v-for="(item, index) in faqList" :key="index" class="faq-item">
              <button class="faq-question" @click="toggleFaq(index)">
                <span>{{ item.question }}</span>
                <span :class="['faq-icon', { 'is-open': openFaqIndex === index }]">+</span>
              </button>
              <div v-if="openFaqIndex === index" class="faq-answer">
                <p style="white-space: pre-line;">{{ item.answer }}</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  <div v-if="showHoldingsModal" class="modal-overlay" @click.self="closeHoldingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æˆ‘çš„å½“å‰æŒä»“</h3>
        <span class="close-icon" @click="closeHoldingsModal">Ã—</span>
      </div>

      <div class="modal-body">
        <div v-for="(row, index) in editingHoldings" :key="index" class="holding-row">
          <div class="input-group">
            <input type="text" v-model="row.code" maxlength="6" placeholder="ä»£ç  (6ä½)" @input="handleCodeInput(row)"
              class="modal-input code" />
          </div>
          <div class="stock-name-display">{{ row.name || '---' }}</div>
          <div class="input-group">
            <input type="number" v-model.number="row.shares" placeholder="è‚¡æ•°" class="modal-input shares" />
          </div>
          <button class="delete-btn" @click="removeHoldingRow(index)">ğŸ—‘ï¸</button>
        </div>

        <button class="add-row-btn" @click="addHoldingRow">
          + æ·»åŠ è‚¡ç¥¨
        </button>
      </div>

      <div class="modal-footer">
        <button class="modal-btn cancel" @click="closeHoldingsModal">å–æ¶ˆ</button>
        <button class="modal-btn save" @click="saveHoldings">ä¿å­˜æŒä»“</button>
      </div>
    </div>
  </div>

  <div v-if="showConfirmModal" class="modal-overlay" @click.self="showConfirmModal = false">
    <div class="modal-content confirm-dialog">
      <div class="modal-header no-border">
        <h3 class="confirm-title">ç¡®è®¤æ›´æ–°</h3>
      </div>

      <div class="modal-body text-center">
        <p class="confirm-text">
          æ˜¯å¦å°†å½“å‰çš„ <strong>è®¡ç®—ç»“æœ</strong> æ›´æ–°ä¸ºæ‚¨çš„æœ€æ–°æŒä»“ï¼Ÿ
        </p>
        <p class="confirm-subtext">
          æ›´æ–°åï¼Œä¸‹æ¬¡è®¡ç®—å°†åŸºäºè¿™ä¸ªæ–°æŒä»“è¿›è¡Œå»ºè®®ã€‚
        </p>
      </div>

      <div class="modal-footer center-footer">
        <button class="modal-btn cancel" @click="showConfirmModal = false">å–æ¶ˆ</button>
        <button class="modal-btn confirm-primary" @click="executeApplyPlan">ç¡®å®šæ›´æ–°</button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { ref, onMounted, nextTick, watch } from 'vue'
  import * as echarts from 'echarts'
  import { useUserStore } from '@/store/user'
  const userStore = useUserStore()
  // å¼•å…¥äº‘å¼€å‘ SDK (è¯·ç¡®ä¿è·¯å¾„ä¸æ‚¨é¡¹ç›®ä¸€è‡´ï¼Œé€šå¸¸æ˜¯ @/lib/cloudbase æˆ–ç±»ä¼¼çš„)
  import app from '@/lib/cloudbase'
  import axios from 'axios'
  const showMessage: any = inject('showMessage')
  const hasCalculated = ref(false) // æ–°å¢å¼€å…³

  // --- æ–°å¢ï¼šèµ„é‡‘åˆ†é…è®¡ç®—å™¨é€»è¾‘ ---
  const inputAmount = ref<number | null>(null) // ç”¨æˆ·è¾“å…¥çš„é‡‘é¢
  const allocationData = ref<Map<string, any>>(new Map()) // å­˜å‚¨è®¡ç®—ç»“æœ Key: stockCode
  const calcSummary = ref({
      totalPlanned: 0,
      utilization: '0.00%',
      msg: ''
  })

  // 1. [æ–°å¢] å®šä¹‰å…¨å¸‚åœºè‚¡ç¥¨æ˜ å°„
  const allStockMap = ref<Record<string, string>>({})

  // 2. [æ–°å¢] è·å–æ˜ å°„å…³ç³»çš„å‡½æ•°
  const fetchStockMap = async () => {
      try {
          // å‡è®¾æ–‡ä»¶æ”¾åœ¨ public/static/stock_map.json
          // æ³¨æ„ï¼šæ ¹æ®ä½ çš„éƒ¨ç½²ç¯å¢ƒï¼Œè·¯å¾„å¯èƒ½æ˜¯ './static/...' æˆ– '/static/...'
          const res = await axios.get('./static/stock_map.json')
          if (res.data) {
              allStockMap.value = res.data
          }
      } catch (err) {
          console.error('æ— æ³•åŠ è½½è‚¡ç¥¨ä»£ç æ˜ å°„è¡¨', err)
      }
  }

  const showHoldingsModal = ref(false)
  // ç”¨æˆ·çœŸå®çš„æŒä»“æ•°æ® (æ¨¡æ‹Ÿä»äº‘ç«¯è·å–)
  const userHoldings = ref<any[]>([])

  watch(
      () => userStore.userInfo,
      newVal => {
          if (newVal && newVal.holdings) {
              // æ·±æ‹·è´ä¸€ä»½ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹ store æ•°æ®
              userHoldings.value = JSON.parse(JSON.stringify(newVal.holdings))
          }
      },
      { immediate: true, deep: true }
  )
  const editingHoldings = ref<any[]>([])
  // 2. [æ–°å¢] å¼¹çª—ç›¸å…³é€»è¾‘
  const openHoldingsModal = () => {
      // 1. æ·±æ‹·è´å½“å‰æŒä»“æ•°æ®
      editingHoldings.value = JSON.parse(JSON.stringify(userHoldings.value))

      // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªåœ¨è¿™é‡Œè¿›è¡Œæ’åº
      // è¿™æ ·åªä¼šå½±å“â€œæˆ‘çš„æŒä»“â€å¼¹çª—é‡Œçš„æ˜¾ç¤ºé¡ºåº
      // ä¸ä¼šå½±å“ä¸»é¡µé¢çš„ç­–ç•¥æ’åï¼Œä¹Ÿä¸ä¼šå½±å“è®¡ç®—é€»è¾‘
      editingHoldings.value.sort((a: any, b: any) => {
          const codeA = a.code ? String(a.code) : ''
          const codeB = b.code ? String(b.code) : ''
          // localeCompare å¯ä»¥ä¿è¯ "00" å¼€å¤´çš„æ’åœ¨ "60" å¼€å¤´çš„å‰é¢
          return codeA.localeCompare(codeB)
      })

      // 3. å¦‚æœæ˜¯ç©ºçš„ï¼Œé»˜è®¤åŠ ä¸€è¡Œ
      if (editingHoldings.value.length === 0) {
          addHoldingRow()
      }

      // 4. æ˜¾ç¤ºå¼¹çª—
      showHoldingsModal.value = true
  }

  const closeHoldingsModal = () => {
      showHoldingsModal.value = false
  }

  const addHoldingRow = () => {
      editingHoldings.value.push({ code: '', name: '', shares: '' })
  }

  const removeHoldingRow = (index: number) => {
      editingHoldings.value.splice(index, 1)
  }

  // ç®€å•çš„æœ¬åœ°æŸ¥æ‰¾åç§°é€»è¾‘
  const handleCodeInput = (row: any) => {
      // ä»…å½“è¾“å…¥è¾¾åˆ° 6 ä½æ—¶æ‰æŸ¥è¯¢
      if (row.code && row.code.length === 6) {
          const code = row.code

          // ä¼˜å…ˆ 1: æŸ¥å…¨å¸‚åœºæ˜ å°„è¡¨
          if (allStockMap.value[code]) {
              row.name = allStockMap.value[code]
          }
          // ä¼˜å…ˆ 2: æŸ¥å½“å‰ç­–ç•¥åˆ—è¡¨ (å…œåº•ï¼Œä¸‡ä¸€JSONæ²¡æ›´æ–°)
          else {
              const foundInStrategy = latestPortfolio.value.find((s: any) => s.code === code)
              if (foundInStrategy) {
                  row.name = foundInStrategy.name
              } else {
                  row.name = 'æœªçŸ¥/æ–°è‚¡'
              }
          }
      } else {
          // è¾“å…¥ä¸è¶³6ä½ï¼Œæ¸…ç©ºåå­—
          row.name = ''
      }
  }

  const saveHoldings = async () => {
      // 1. è¿‡æ»¤æ— æ•ˆæ•°æ®
      const validHoldings = editingHoldings.value.filter(
          (h: any) => h.code.length === 6 && h.shares > 0
      )

      try {
          // 2. ã€æ”¹è¿™é‡Œã€‘ä¸å†ç›´æ¥è°ƒäº‘å‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨ Store çš„ action
          await userStore.updateHoldings(validHoldings)

          showMessage('æŒä»“ä¿å­˜æˆåŠŸ', 'success')
          closeHoldingsModal()

          // 3. é‡æ–°è§¦å‘ç­–ç•¥è®¡ç®—ï¼ˆå› ä¸º store æ›´æ–°äº†ï¼Œwatch ä¼šè‡ªåŠ¨æ›´æ–° userHoldingsï¼Œè¿™é‡Œåªéœ€è¦é‡æ–°è®¡ç®—å»ºè®®ï¼‰
          if (hasCalculated.value) {
              handleCalculate()
          }
      } catch (err: any) {
          console.error(err)
          showMessage(err.message || 'ä¿å­˜å¤±è´¥', 'error')
      }
  }
  // ä¿®æ”¹ä¸º async å‡½æ•°ï¼Œå› ä¸ºæ¶‰åŠåˆ°äº‘ç«¯ä¿å­˜
  const applyPlanToHoldings = async () => {
      if (!hasCalculated.value) return

      const newHoldings: any[] = []

      // 1. éå†è®¡ç®—ç»“æœï¼Œæ„å»ºæ–°çš„æŒä»“æ•°ç»„
      allocationData.value.forEach((val: any, code: string) => {
          if (val.shares > 0) {
              const stockInfo = latestPortfolio.value.find((s: any) => s.code === code)
              newHoldings.push({
                  code: code,
                  name: stockInfo ? stockInfo.name : 'æœªçŸ¥',
                  shares: val.shares
              })
          }
      })

      // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨ Store çš„æ–¹æ³•ä¿å­˜åˆ°äº‘ç«¯
      try {
          await userStore.updateHoldings(newHoldings)

          showMessage('å·²å°†ç›®æ ‡ç»„åˆå½•å…¥ä¸ºå½“å‰æŒä»“ï¼', 'success')

          // 3. ä¿å­˜æˆåŠŸåï¼Œé‡æ–°è§¦å‘ä¸€ä¸‹è®¡ç®—
          // æ­¤æ—¶â€œå½“å‰æŒä»“â€å’Œâ€œç›®æ ‡æŒä»“â€åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œ
          // æ‰€ä»¥ä¸‹æ–¹çš„â€œè°ƒä»“å»ºè®®â€åº”è¯¥ä¼šå˜ä¸ºç©ºï¼ˆæˆ–æ˜¾ç¤ºæ— æ“ä½œï¼‰ï¼Œè¿™æ˜¯ç¬¦åˆé€»è¾‘çš„ã€‚
          handleCalculate()
      } catch (err: any) {
          console.error(err)
          showMessage(err.message || 'å½•å…¥å¤±è´¥', 'error')
      }
  }
  // è®¡ç®—æœ€å°èµ·æŠ•é—¨æ§› (æœ€é«˜ä»·è‚¡ç¥¨çš„1æ‰‹ * 10)
  const minThreshold = computed(() => {
      if (!latestPortfolio.value || latestPortfolio.value.length === 0) return 0
      const maxPrice = Math.max(...latestPortfolio.value.map((s: any) => s.price))
      return Math.ceil(maxPrice * 100 * 10)
  })

  // æ‰§è¡Œè®¡ç®— (å®Œå…¨å¤åˆ»æ‚¨çš„ç®—æ³•)
  const handleCalculate = () => {
      const stocks = latestPortfolio.value
      const totalFunds = Number(inputAmount.value)

      // 1. åŸºç¡€æ ¡éªŒ
      if (!totalFunds || totalFunds <= 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•èµ„é‡‘é¢ï¼', 'error')
          return
      }
      if (totalFunds < minThreshold.value) {
          showMessage(
              `èµ„é‡‘é‡è¿‡å°ï¼Œæ— æ³•æœ‰æ•ˆè¿›è¡Œç­‰æƒé…ç½®ã€‚\nå½“å‰ç­–ç•¥å»ºè®®æœ€ä½èµ·æŠ•é‡‘é¢ä¸ºï¼š${minThreshold.value}å…ƒ\n(åŸºäºæœ€é«˜ä»·è‚¡1æ‰‹ä»·æ ¼çš„10å€è®¡ç®—)`,
              'error'
          )
          return
      }

      // 2. ç®—æ³•åˆå§‹åŒ–
      // å‡è®¾èµ„é‡‘åˆ©ç”¨ç‡ä¸º 100% (æˆ–è€…æ‚¨å¯ä»¥åƒåŸä»£ç é‚£æ ·è®¾ç½®ä¸€ä¸ªæ¯”ä¾‹ï¼Œè¿™é‡Œé»˜è®¤å…¨é¢åˆ©ç”¨)
      const fundsForAllocation = totalFunds
      let remainingFunds = fundsForAllocation
      const tempMap = new Map()
      let totalAllocated = 0

      // 3. å¾ªç¯è®¡ç®— (ç€‘å¸ƒæµåˆ†é…)
      for (let i = 0; i < stocks.length; i++) {
          const stock = stocks[i]
          const currentPrice = stock.price // æ³¨æ„ï¼šæ‚¨åŸä»£ç æ˜¯ spï¼Œè¿™é‡Œé€‚é…ä¸º price

          if (!currentPrice || currentPrice <= 0) continue

          const remainingStocksCount = stocks.length - i
          // æ ¸å¿ƒé€»è¾‘ï¼šå‰©ä½™èµ„é‡‘ / å‰©ä½™è‚¡ç¥¨æ•°
          const idealInvestmentPerStock = remainingFunds / remainingStocksCount
          const idealShares = idealInvestmentPerStock / currentPrice

          // å››èˆäº”å…¥åˆ°æ•´ç™¾
          let sharesToBuy = Math.round(idealShares / 100) * 100

          // å…œåº•é€»è¾‘ï¼šå¦‚æœè®¡ç®—å‡º0æ‰‹ï¼Œå¼ºåˆ¶ç»™1æ‰‹ (å‰ææ˜¯èµ„é‡‘è¶³å¤Ÿï¼Œä¸‹é¢ä¼šæ ¡éªŒ)
          if (sharesToBuy === 0) sharesToBuy = 100

          let actualCost = sharesToBuy * currentPrice

          // èµ„é‡‘ä¸è¶³æ—¶çš„å›é€€é€»è¾‘ (å‡å°‘æ‰‹æ•°ç›´åˆ°ä¹°å¾—èµ·)
          while (actualCost > remainingFunds && sharesToBuy > 0) {
              sharesToBuy -= 100
              actualCost = sharesToBuy * currentPrice
          }

          // è®°å½•ç»“æœ
          if (sharesToBuy > 0) {
              remainingFunds -= actualCost
              totalAllocated += actualCost

              const actualWeight = actualCost / fundsForAllocation

              tempMap.set(stock.code, {
                  shares: sharesToBuy,
                  cost: actualCost,
                  weight: (actualWeight * 100).toFixed(2) + '%'
              })
          } else {
              // æç«¯æƒ…å†µä¹°ä¸èµ·
              tempMap.set(stock.code, { shares: 0, cost: 0, weight: '0%' })
          }
      }

      // 4. æ›´æ–°çŠ¶æ€
      allocationData.value = tempMap
      calcSummary.value = {
          totalPlanned: totalAllocated,
          utilization: ((totalAllocated / fundsForAllocation) * 100).toFixed(2) + '%',
          msg: 'è®¡ç®—å®Œæˆ'
      }
      hasCalculated.value = true

      // 1. æ‰§è¡ŒåŸæœ‰çš„ç€‘å¸ƒæµåˆ†é…ç®—æ³• (ä¿æŒä½ åŸæœ¬çš„ä»£ç ä¸å˜)
      // ... (ä½ åŸæ¥çš„ for å¾ªç¯è®¡ç®— sharesToBuy) ...
      // å‡è®¾ç°åœ¨ allocationData.value å·²ç»æœ‰äº† { '600xxx': { shares: 1000 ... } }

      // 2. [æ–°å¢] ç”ŸæˆåŠ¨æ€è°ƒä»“å»ºè®® (Diff ç®—æ³•)
      const newBuyList: any[] = []
      const newSellList: any[] = []

      // è·å–æ‰€æœ‰æ¶‰åŠçš„è‚¡ç¥¨ä»£ç  (ç­–ç•¥ä¸­çš„ + æŒä»“ä¸­çš„)
      const allCodes = new Set([
          ...latestPortfolio.value.map((s: any) => s.code),
          ...userHoldings.value.map((h: any) => h.code)
      ])

      allCodes.forEach(code => {
          // ç›®æ ‡æŒä»“
          const targetData = allocationData.value.get(code)
          const targetShares = targetData ? targetData.shares : 0

          // å½“å‰æŒä»“
          const currentData = userHoldings.value.find((h: any) => h.code === code)
          const currentShares = currentData ? currentData.shares : 0

          // è‚¡ç¥¨åç§°æŸ¥æ‰¾
          let stockName = currentData?.name
          if (!stockName) {
              const s = latestPortfolio.value.find((item: any) => item.code === code)
              stockName = s ? s.name : code
          }

          const diff = targetShares - currentShares

          if (diff > 0) {
              // --- ä¹°å…¥ä¾§ ---
              // 0 -> æœ‰ï¼šå…¨æ–°ä¹°å…¥ (4å­—)
              // æœ‰ -> æ›´å¤šï¼šå¢æŒ (2å­—)
              const isNewEntry = currentShares === 0
              newBuyList.push({
                  code,
                  name: stockName,
                  action: isNewEntry ? 'å…¨æ–°ä¹°å…¥' : 'å¢æŒ',
                  subType: isNewEntry ? 'new-buy' : 'add-buy', // æ ·å¼æ ‡è®°
                  shares: diff
              })
          } else if (diff < 0) {
              // --- å–å‡ºä¾§ ---
              // æœ‰ -> 0ï¼šå…¨éƒ¨å–å‡º (4å­—)
              // æ›´å¤š -> å°‘ï¼šå‡æŒ (2å­—)
              const isClearance = targetShares === 0
              newSellList.push({
                  code,
                  name: stockName,
                  action: isClearance ? 'å…¨éƒ¨å–å‡º' : 'å‡æŒ',
                  subType: isClearance ? 'clear-sell' : 'cut-sell', // æ ·å¼æ ‡è®°
                  shares: Math.abs(diff)
              })
          }
      })

      // æ’åºä¼˜åŒ–ï¼šæŠŠâ€œå…¨éƒ¨å–å‡ºâ€å’Œâ€œå…¨æ–°ä¹°å…¥â€è¿™äº›å¤§åŠ¨ä½œæ’åœ¨æœ€å‰é¢ï¼Œé˜²æ­¢æ¼çœ‹
      newSellList.sort((a, b) => (a.subType === 'clear-sell' ? -1 : 1))
      newBuyList.sort((a, b) => (a.subType === 'new-buy' ? -1 : 1))

      // è¦†ç›–åŸæœ¬ä»äº‘ç«¯è·å–çš„é™æ€å»ºè®®
      buyList.value = newBuyList
      sellList.value = newSellList

      // ... (æ›´æ–° calcSummary ç­‰çŠ¶æ€) ...
      hasCalculated.value = true
  }

  // ... (ä¿ç•™åŸæœ‰çš„ fetchStrategyData, chart ç­‰é€»è¾‘)
  // --- 1. åŸºç¡€æ•°æ® ---
  const formattedDate = ref('åŠ è½½ä¸­...')
  const isLoading = ref(true)

  // --- 2. æŒä»“ä¸è°ƒä»“æ•°æ® ---
  const latestPortfolio: any = ref([]) // æ ¸å¿ƒæŒä»“
  const sellList: any = ref([]) // å»ºè®®å–å‡º
  const buyList: any = ref([]) // å»ºè®®ä¹°å…¥

  // --- 3. è·å–äº‘ç«¯æ•°æ®å‡½æ•° ---
  const fetchStrategyData = async () => {
      try {
          const res = await app.callFunction({
              name: 'getMicroCapData10' // åˆšæ‰åˆ›å»ºçš„äº‘å‡½æ•°åç§°
          })

          if (res.result.success && res.result.data) {
              const data = res.result.data

              // 1. æ›´æ–°æ—¥æœŸ
              formattedDate.value = data.updated_at

              // 2. æ›´æ–°æŒä»“åˆ—è¡¨ (æ•°æ®åº“å­—æ®µ ranking -> å‰ç«¯ latestPortfolio)
              latestPortfolio.value = data.ranking || []

              // 3. æ›´æ–°è°ƒä»“å»ºè®® (æ•°æ®åº“å­—æ®µ adjustments -> æ‹†åˆ†ä¸º buy/sell)
              const adj = data.adjustments || []

              // è¿‡æ»¤å‡ºä¹°å…¥ (action: 'buy')
              // buyList.value = adj
              //     .filter((item: any) => item.action === 'buy')
              //     .map((item: any) => ({
              //         code: item.code,
              //         name: item.name,
              //         action: 'ä¹°å…¥' // ç”¨äºå‰ç«¯æ˜¾ç¤ºæ–‡å­—
              //     }))

              // // è¿‡æ»¤å‡ºå–å‡º (action: 'sell')
              // sellList.value = adj
              //     .filter((item: any) => item.action === 'sell')
              //     .map((item: any) => ({
              //         code: item.code,
              //         name: item.name,
              //         action: 'å–å‡º' // ç”¨äºå‰ç«¯æ˜¾ç¤ºæ–‡å­—
              //     }))
          } else {
              console.warn('æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®:', res.result.msg)
              formattedDate.value = 'æš‚æ— æ•°æ®'
          }
      } catch (err) {
          console.error('äº‘å‡½æ•°è°ƒç”¨å¤±è´¥', err)
          formattedDate.value = 'æ•°æ®åŠ è½½å¤±è´¥'
      } finally {
          isLoading.value = false
      }
  }

  // --- 4. å›¾è¡¨é€»è¾‘ (ä¿æŒåŸæ ·ï¼Œä¹Ÿå¯ä»¥åç»­æ¢æˆçœŸå®æ•°æ®) ---
  const chartContainer = ref<HTMLElement | null>(null)
  let myChart: echarts.ECharts | null = null

  const initChart = (dates: any, strategyData: any, benchmarkData: any) => {
      if (!chartContainer.value) return
      myChart = echarts.init(chartContainer.value)

      const option = {
          backgroundColor: 'transparent',
          tooltip: { trigger: 'axis' },
          grid: { top: '15%', left: '3%', right: '4%', bottom: '10%', containLabel: true },
          legend: { data: ['å¾®ç›˜è‚¡ç­–ç•¥', 'æ²ªæ·±300'], textStyle: { color: '#b0c4de' }, top: 0 },
          xAxis: {
              type: 'category',
              data: dates,
              axisLine: { lineStyle: { color: '#8392A5' } },
              axisLabel: { show: false }
          },
          yAxis: {
              type: 'value',
              splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
              axisLabel: { color: '#8392A5' },
              scale: true
          },
          series: [
              {
                  name: 'å¾®ç›˜è‚¡ç­–ç•¥',
                  type: 'line',
                  data: strategyData,
                  itemStyle: { color: '#f0e68c' },
                  showSymbol: false,
                  lineStyle: { width: 2 }
              },
              {
                  name: 'æ²ªæ·±300',
                  type: 'line',
                  data: benchmarkData,
                  itemStyle: { color: '#5470c6' },
                  showSymbol: false,
                  lineStyle: { width: 1, type: 'dashed' },
                  areaStyle: { opacity: 0.1, color: '#5470c6' }
              }
          ]
      }
      myChart.setOption(option)
  }

  // --- 5. çƒ­åŠ›å›¾ä¸è¾…åŠ©æ•°æ® (ä¿æŒåŸæ ·) ---
  const monthlyReturns = ref([
      {
          year: 2025,
          months: [
              '-0.05',
              '12.88',
              '-1.80',
              '0.40',
              '10.27',
              '10.27',
              '7.67',
              '1.23',
              '5.46',
              '7.72',
              '5.10',
              '-2.26'
          ],
          total: '72.04'
      },
      {
          year: 2024,
          months: [
              '0.18',
              '-4.90',
              '17.12',
              '0.29',
              '1.52',
              '-10.97',
              '10.58',
              '4.66',
              '26.03',
              '15.62',
              '12.36',
              '-9.70'
          ],
          total: '73.06'
      },
      {
          year: 2023,
          months: [
              '-0.00',
              '5.02',
              '-4.07',
              '0.07',
              '4.24',
              '5.93',
              '10.51',
              '1.59',
              '3.36',
              '2.53',
              '6.92',
              '1.77'
          ],
          total: '44.12'
      },
      {
          year: 2022,
          months: [
              '0.04',
              '9.15',
              '5.58',
              '-0.72',
              '13.34',
              '6.19',
              '10.11',
              '2.86',
              '-6.13',
              '5.19',
              '12.20',
              '-5.17'
          ],
          total: '63.92'
      },
      {
          year: 2021,
          months: [
              '0.24',
              '9.49',
              '8.78',
              '-0.18',
              '10.52',
              '5.29',
              '-1.31',
              '8.85',
              '0.01',
              '-2.89',
              '12.70',
              '8.68'
          ],
          total: '77.21'
      },
      {
          year: 2020,
          months: [
              '0.20',
              '15.34',
              '3.81',
              '-0.48',
              '3.26',
              '2.71',
              '11.22',
              '8.62',
              '-3.57',
              '0.17',
              '5.92',
              '-7.90'
          ],
          total: '44.15'
      },
      {
          year: 2019,
          months: [
              '-0.02',
              '23.15',
              '13.47',
              '0.61',
              '6.42',
              '5.01',
              '1.79',
              '-2.49',
              '3.29',
              '3.00',
              '-2.93',
              '9.04'
          ],
          total: '75.57'
      },
      {
          year: 2018,
          months: [
              '0.04',
              '-7.32',
              '13.57',
              '-0.10',
              '2.03',
              '-12.79',
              '5.97',
              '-6.67',
              '2.16',
              '-1.56',
              '13.35',
              '-3.50'
          ],
          total: '1.83'
      },
      {
          year: 2017,
          months: [
              '0.20',
              '4.61',
              '-6.32',
              '-0.30',
              '-7.62',
              '2.52',
              '-7.48',
              '12.64',
              '0.52',
              '0.12',
              '-6.91',
              '-2.84'
          ],
          total: '-12.04'
      },
      {
          year: 2016,
          months: [
              '-1.48',
              '1.78',
              '29.00',
              '-0.16',
              '-1.20',
              '7.19',
              '-1.93',
              '8.70',
              '6.42',
              '4.32',
              '6.43',
              '4.18'
          ],
          total: '79.47'
      },
      {
          year: 2015,
          months: [
              '0.20',
              '8.26',
              '27.69',
              '-0.04',
              '44.18',
              '-2.01',
              '-15.22',
              '-5.77',
              '1.82',
              '29.94',
              '23.85',
              '20.89'
          ],
          total: '209.56'
      },
      {
          year: 2014,
          months: [
              '-0.47',
              '6.66',
              '1.83',
              '-0.38',
              '5.43',
              '9.57',
              '12.58',
              '11.62',
              '20.81',
              '2.01',
              '5.76',
              '-13.22'
          ],
          total: '76.82'
      },
      {
          year: 2013,
          months: [
              '0.00',
              '7.09',
              '-3.85',
              '-0.28',
              '19.13',
              '-12.81',
              '14.25',
              '11.10',
              '6.80',
              '0.21',
              '14.21',
              '-1.12'
          ],
          total: '63.62'
      }
  ])

  const getHeatmapStyle = (value: any) => {
      if (value === null || value === undefined) return {}
      if (value === 0) return { backgroundColor: 'transparent' }
      if (value > 0) {
          const opacity = Math.min(Math.abs(value) / 15, 1)
          return {
              backgroundColor: `rgba(255, 87, 34, ${0.2 + opacity * 0.8})`,
              color: '#fff',
              fontWeight: value > 10 ? 'bold' : 'normal'
          }
      } else {
          const opacity = Math.min(Math.abs(value) / 15, 1)
          return {
              backgroundColor: `rgba(0, 196, 151, ${0.2 + opacity * 0.8})`,
              color: '#fff',
              fontWeight: value < -10 ? 'bold' : 'normal'
          }
      }
  }

  const getValueColorClass = (val: number) => {
      if (val > 0) return 'text-red'
      if (val < 0) return 'text-green'
      return ''
  }

  // --- FAQ & é£é™©æ•°æ® (ä¿æŒä¸å˜) ---
  const drawdownDist = ref([
      { range: '0%~10%', count: 193 },
      { range: '10%~20%', count: 11 },
      { range: '20%~30%', count: 1 },
      { range: '30%~40%', count: 2 },
      { range: '40%~50%', count: 0 },
      { range: '>50%', count: 1 }
  ])
  const topDrawdowns = ref([
      {
          startDate: '2015-06-12',
          troughDate: '2015-07-08',
          endDate: '2015-11-24',
          drawdown: '-50.92',
          rawDd: -0.5092435194746736,
          ddDays: 26,
          fixDays: 139
      },
      {
          startDate: '2017-03-20',
          troughDate: '2018-10-18',
          endDate: '2019-02-25',
          drawdown: '-33.91',
          rawDd: -0.3390770332197848,
          ddDays: 577,
          fixDays: 130
      },
      {
          startDate: '2024-01-31',
          troughDate: '2024-02-07',
          endDate: '2024-02-27',
          drawdown: '-33.73',
          rawDd: -0.33725746954900077,
          ddDays: 7,
          fixDays: 20
      },
      {
          startDate: '2024-05-17',
          troughDate: '2024-06-06',
          endDate: '2024-09-24',
          drawdown: '-21.18',
          rawDd: -0.21177939390773315,
          ddDays: 20,
          fixDays: 110
      },
      {
          startDate: '2024-12-12',
          troughDate: '2025-01-02',
          endDate: '2025-03-18',
          drawdown: '-18.07',
          rawDd: -0.18069585108981195,
          ddDays: 21,
          fixDays: 75
      },
      {
          startDate: '2020-09-08',
          troughDate: '2021-02-08',
          endDate: '2021-03-01',
          drawdown: '-17.12',
          rawDd: -0.17118920909998162,
          ddDays: 153,
          fixDays: 21
      },
      {
          startDate: '2016-02-24',
          troughDate: '2016-02-29',
          endDate: '2016-03-18',
          drawdown: '-15.48',
          rawDd: -0.15476190476190474,
          ddDays: 5,
          fixDays: 18
      },
      {
          startDate: '2014-11-28',
          troughDate: '2014-12-23',
          endDate: '2015-03-09',
          drawdown: '-14.94',
          rawDd: -0.14941677189467428,
          ddDays: 25,
          fixDays: 76
      },
      {
          startDate: '2016-05-05',
          troughDate: '2016-05-18',
          endDate: '2016-06-28',
          drawdown: '-14.42',
          rawDd: -0.14424527862902423,
          ddDays: 13,
          fixDays: 41
      },
      {
          startDate: '2013-05-30',
          troughDate: '2013-06-25',
          endDate: '2013-08-01',
          drawdown: '-13.22',
          rawDd: -0.13217296487973187,
          ddDays: 26,
          fixDays: 37
      }
  ])
  const openFaqIndex = ref<number | null>(0)
  const toggleFaq = (index: number) => {
      openFaqIndex.value = openFaqIndex.value === index ? null : index
  }
  const faqList = ref([
      {
          question: 'æˆ‘å¦‚ä½•å‚ä¸è¯¥ç­–ç•¥ï¼Ÿ',
          answer: 'æœ¬ç­–ç•¥ç²¾é€‰æ²ªæ·±ä¸»æ¿10åªå°å¸‚å€¼ä¸ªè‚¡ï¼Œæ— ç§‘åˆ›/åˆ›ä¸šæ¿é—¨æ§›ï¼Œä½†è¯·åŠ¡å¿…è®¤çŸ¥å…¶é«˜æ³¢åŠ¨é£é™©ã€‚é¦–æ¬¡å»ºä»“å»ºè®®åœ¨å‘¨ä¸€ä¸Šåˆ9:30è¿›è¡Œï¼›åç»­è¯·ä¸¥æ ¼è·Ÿéšä¿¡å·ï¼ŒåŠ¡å¿…åœ¨å‘¨ä¸€9:30ç¬¬ä¸€æ—¶é—´å®Œæˆè°ƒä»“ï¼Œä»¥å‡å°‘å› è‚¡ä»·å¿«é€Ÿæ³¢åŠ¨å¸¦æ¥çš„æ»‘ç‚¹æŸè€—ã€‚'
      },
      {
          question: '10æ”¯è‚¡ç¥¨æˆ‘åº”è¯¥å¦‚ä½•åˆ†é…èµ„é‡‘ï¼Ÿ',
          answer: 'å»ºè®®ä¸¥æ ¼é‡‡å–â€œç­‰æƒé…ç½®â€åŸåˆ™ã€‚æ— è®ºä¸Šå‘¨ä¸ªè‚¡æ¶¨è·Œå¦‚ä½•ï¼Œåœ¨æ¯æ¬¡è°ƒä»“å®Œæˆåï¼Œè¯·åŠ¡å¿…é€šè¿‡ä¹°å–æ“ä½œï¼Œå°†è¿™10åªè‚¡ç¥¨çš„æŒä»“å¸‚å€¼è°ƒæ•´è‡³å¤§è‡´ç›¸ç­‰ï¼Œå³æ¯åªè‚¡ç¥¨å„å ç­–ç•¥æ€»ä»“ä½çš„10%ã€‚è¿™ç§å®šæœŸçš„â€œå†å¹³è¡¡â€æœ‰åŠ©äºè¢«åŠ¨å®ç°é«˜æŠ›ä½å¸ï¼Œç»´æŒç»„åˆé£é™©å‡è¡¡ã€‚'
      },
      {
          question: 'ä¸ºä½•å›æµ‹ä¸­1æœˆå’Œ4æœˆçš„æ”¶ç›Šè¡¨ç°ç‰¹æ®Šï¼Ÿ',
          answer: 'è¿™æ˜¯ç­–ç•¥ä¸»åŠ¨è§„é¿å¾®ç›˜è‚¡â€œæ—¥å†æ•ˆåº”â€çš„ç»“æœã€‚1æœˆé¢ä¸´å¹´å…³æµåŠ¨æ€§æ”¶ç´§ï¼Œ4æœˆå­˜åœ¨è´¢æŠ¥å­£æš´é›·é£é™©ï¼Œå› æ­¤æ¨¡å‹è®¾å®šäº†ç©ºä»“é¿é™©æœºåˆ¶ã€‚è¡¨æ ¼ä¸­çš„å¾®å°æ•°å€¼æ˜¯æœˆåˆæ¸…ä»“ç¬é—´äº§ç”Ÿçš„æ³¢åŠ¨ï¼Œå®ç›˜æ“ä½œä¸­å»ºè®®æŠ•èµ„è€…æ ¹æ®æƒ…å†µçµæ´»æå‰ç©ºä»“è§‚æœ›ã€‚'
      },
      {
          question: 'æˆ‘åº”è¯¥é…ç½®å¤šå°‘æ¯”ä¾‹ï¼Ÿ',
          answer: 'å¾®ç›˜è‚¡å±äºé«˜é£é™©ã€é«˜å¼¹æ€§çš„è¿›æ”»å‹ç­–ç•¥ï¼Œæ—¨åœ¨åšå–Alphaè¶…é¢æ”¶ç›Šã€‚ä½†è¯¥ç­–ç•¥å¯¹æµåŠ¨æ€§æå…¶æ•æ„Ÿï¼Œè‹¥é‡å¸‚åœºé»‘å¤©é¹…æˆ–èµ„é‡‘é¢æ”¶ç´§ï¼Œå‡€å€¼æ³¢åŠ¨å°†æ˜¾è‘—æ”¾å¤§ã€‚å› æ­¤ï¼Œå»ºè®®å°†å…¶ä½œä¸ºæŠ•èµ„ç»„åˆä¸­çš„â€œå«æ˜Ÿèµ„äº§â€ï¼Œé…ç½®æ¯”ä¾‹ä¸¥æ ¼æ§åˆ¶åœ¨20%ä»¥å†…ï¼Œä»¥å¹³è¡¡æ•´ä½“é£é™©ã€‚'
      }
  ])

  const getlocalData = () => {
      axios.get('./static/microCapData.json').then(res => {
          const data = res.data
          initChart(data.dateList, data.strategyData, data.hs300)
      })
  }
  getlocalData()

  // --- ç”Ÿå‘½å‘¨æœŸ ---
  onMounted(() => {
      fetchStrategyData()
      fetchStockMap()
      nextTick(() => {
          // 2. åˆå§‹åŒ–å›¾è¡¨
          window.addEventListener('resize', () => myChart?.resize())
      })
  })

  // [æ–°å¢] æ§åˆ¶ç¡®è®¤å¼¹çª—æ˜¾ç¤º
  const showConfirmModal = ref(false)

  // 1. [ä¿®æ”¹] ç‚¹å‡»â€œå½•å…¥æ­¤ç»“æœâ€æŒ‰é’®æ—¶è§¦å‘çš„å‡½æ•°
  const requestApplyPlan = () => {
      // å…ˆæ£€æŸ¥ç™»å½•ï¼Œæ²¡ç™»å½•ç›´æ¥æ‹¦æˆªï¼Œä¸å¼¹ç¡®è®¤æ¡†
      if (!userStore.isLoggedIn) {
          showMessage('è¯·å…ˆç™»å½•åä¿å­˜æ•°æ®', 'warning')
          return
      }

      if (!hasCalculated.value) return

      // æ‰“å¼€ç¡®è®¤å¼¹çª—
      showConfirmModal.value = true
  }

  // 2. [ä¿®æ”¹] çœŸæ­£çš„æ‰§è¡Œå‡½æ•° (åŸ applyPlanToHoldings æ”¹åæˆ–ä¿®æ”¹å†…å®¹)
  const executeApplyPlan = async () => {
      // å…³é—­å¼¹çª—
      showConfirmModal.value = false

      const newHoldings: any[] = []

      // ... åŸæœ‰çš„æ„å»º newHoldings é€»è¾‘ ...
      allocationData.value.forEach((val: any, code: string) => {
          if (val.shares > 0) {
              const stockInfo = latestPortfolio.value.find((s: any) => s.code === code)
              newHoldings.push({
                  code: code,
                  name: stockInfo ? stockInfo.name : 'æœªçŸ¥',
                  shares: val.shares
              })
          }
      })

      try {
          await userStore.updateHoldings(newHoldings)
          showMessage('å·²å°†ç›®æ ‡ç»„åˆå½•å…¥ä¸ºå½“å‰æŒä»“ï¼', 'success')
          handleCalculate() // é‡æ–°è®¡ç®—ä»¥åˆ·æ–°ç•Œé¢
      } catch (err: any) {
          console.error(err)
          showMessage(err.message || 'å½•å…¥å¤±è´¥', 'error')
      }
  }
</script>

<style scoped>
  /* =========================================
                                                                                                                                                                                                                                          å…¨å±€ä¸åŸºç¡€æ ·å¼ (Theme: #f0e68c / Khaki)
                                                                                                                                                                                                                                          ========================================= */
  :global(body),
  :global(html) {
      overflow-x: hidden;
      margin: 0;
      padding: 0;
  }

  @keyframes fadeInUp {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  .page-wrapper {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #121212;
      color: #ffffff;
      min-height: 100vh;
      padding: 3rem 1rem;
      /* å¾®ç›˜è‚¡ä¸»é¢˜è‰²èƒŒæ™¯æ¸å˜ */
      background: radial-gradient(circle at 15% 50%, #4a4a2a, transparent 40%),
          radial-gradient(circle at 85% 50%, #4a4a2a, transparent 40%), #121212;
  }

  .main-container {
      max-width: 900px;
      margin: 0 auto;
  }

  /* é¡µé¢å¤´éƒ¨ */
  .page-header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInUp 0.5s ease-out forwards;
  }

  .back-button {
      color: #b0c4de;
      text-decoration: none;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      display: inline-block;
  }

  .back-button:hover {
      color: #f0e68c;
  }

  .main-title {
      font-size: 2.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
  }

  .title-icon {
      font-size: 2.8rem;
      color: #f0e68c;
      text-shadow: 0 0 15px #f0e68c;
  }

  .subtitle {
      font-size: 1.1rem;
      color: #b0c4de;
  }

  /* å†…å®¹å¡ç‰‡ */
  .content-grid {
      display: grid;
      gap: 1.5rem;
  }

  .content-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem 2rem;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.5s ease-out forwards;
      min-width: 0;
  }

  .content-card:hover {
      border-color: rgba(240, 230, 140, 0.5); /* Theme color hover */
  }

  .card-title {
      font-size: 1.4rem;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 1rem;
      border-left: 4px solid #f0e68c; /* Theme border */
      padding-left: 1rem;
      color: #fff;
  }

  .card-title.no-margin {
      margin-bottom: 0;
  }

  .card-title.no-border {
      border-left: none;
      padding-left: 0;
  }

  .card-description {
      font-size: 0.95rem;
      color: #b0c4de;
      line-height: 1.8;
      margin-bottom: 1rem;
  }

  .idea-list {
      list-style-type: none;
      padding-left: 1.5rem;
      color: #b0c4de;
      line-height: 1.8;
  }

  .idea-list li {
      position: relative;
      margin-bottom: 0.5rem;
  }

  .idea-list li::before {
      content: 'âœ”';
      position: absolute;
      left: -1.5rem;
      color: #f0e68c;
  }

  /* é£é™©å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
  .risk-warning-card {
      border-left-color: #dc3545;
  }
  .risk-warning-card .card-title {
      border-left-color: #dc3545;
      color: #e24141;
  }

  /* =========================================
                                                                                                                                                                                                                                                                                                                                     æ–°å¢æ¨¡å—æ ·å¼ï¼šæœ€æ–°æŒä»“ä¸è°ƒä»“
                                                                                                                                                                                                                                                                                                                                     ========================================= */
  .card-subtitle {
      font-size: 1.1rem;
      font-weight: bold;
      color: #ffffff;
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
  }

  /* .data-table {
                                                                                                                                                                                                                                                                          width: 100%;
                                                                                                                                                                                                                                                                          border-collapse: collapse;
                                                                                                                                                                                                                                                                          min-width: 600px;
                                                                                                                                                                                                                                                                          table-layout: fixed;
                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                      .data-table th,
                                                                                                                                                                                                                                                                      .data-table td {
                                                                                                                                                                                                                                                                          padding: 0.8rem 1rem;
                                                                                                                                                                                                                                                                          text-align: left;
                                                                                                                                                                                                                                                                          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                      .data-table th {
                                                                                                                                                                                                                                                                          color: #ffffff;
                                                                                                                                                                                                                                                                          font-weight: bold;
                                                                                                                                                                                                                                                                          border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                                                                                                                                                                                                                                                                          white-space: nowrap;
                                                                                                                                                                                                                                                                      } */

  .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 0;
  }

  .data-table th {
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
      font-weight: bold;
      padding: 0.8rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      white-space: nowrap;
  }

  .data-table td {
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.8rem;
      text-align: center;
      color: #b0c4de;
      font-size: 0.9rem;
      white-space: nowrap;
  }

  .data-table td {
      color: #b0c4de;
  }

  .code-font {
      /* font-family: 'Roboto Mono', monospace; */
      opacity: 1;
  }

  .text-red {
      color: #ff5722 !important;
  }
  .text-green {
      color: #00c497 !important;
  }

  /* è°ƒä»“æŒ‡å¼• Grid */
  .adjustments-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 1rem;
  }

  .adjustment-title {
      font-size: 1rem;
      margin: 0 0 0.8rem 0;
      font-weight: 600;
  }
  .adjustment-title.buy {
      color: #00c497;
  }
  .adjustment-title.sell {
      color: #ff5722;
  }

  .adjustment-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
  }

  .adjustment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #b0c4de;
  }

  .adjustment-item-empty {
      color: #8392a5;
      font-size: 0.9rem;
      padding: 0.5rem 0;
  }

  .action-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #fff;
  }
  .action-badge.buy {
      background-color: rgba(0, 196, 151, 0.7);
  }
  .action-badge.sell {
      background-color: rgba(255, 87, 34, 0.7);
  }

  /* =========================================
                                                                                                                                                                                                                                                                                                                                     æ–°å¢æ¨¡å—æ ·å¼ï¼šå›¾è¡¨ä¸ç»Ÿè®¡ (Charts & Stats)
                                                                                                                                                                                                                                                                                                                                     ========================================= */
  .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
  }

  .period-badge {
      font-size: 0.8rem;
      color: #8392a5;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .echart-container {
      width: 100%;
      height: 350px;
      margin-top: 1rem;
  }

  .stats-bar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      background: rgba(0, 0, 0, 0.2);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      gap: 1rem;
  }

  .stat-label {
      color: #8392a5;
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
  }

  .stat-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #fff;
  }

  .stat-value.highlight {
      color: #f0e68c;
  } /* Yellow for Micro-cap */
  .stat-value.negative {
      color: #00c497;
  }

  /* =========================================
                                                                                                                                                                                                                                                                                                                                     æ–°å¢æ¨¡å—æ ·å¼ï¼šçƒ­åŠ›å›¾ (Heatmap)
                                                                                                                                                                                                                                                                                                                                     ========================================= */
  .heatmap-container {
      overflow-x: auto;
  }

  .heatmap-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 800px;
  }

  .heatmap-table th {
      padding: 0.8rem 0.2rem;
      font-size: 0.85rem;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      white-space: nowrap;
  }

  .heatmap-table td {
      padding: 0.6rem 0.2rem;
      text-align: center;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .year-col {
      font-weight: bold;
      background: rgba(255, 255, 255, 0.02);
      color: #b0c4de;
  }

  .year-total {
      font-weight: bold;
      color: #fff;
  }

  /* =========================================
                                                                                                                                                                                                                                                                                                                                     æ–°å¢æ¨¡å—æ ·å¼ï¼šé£é™©åˆ†æ
                                                                                                                                                                                                                                                                                                                                     ========================================= */
  .risk-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
  }

  .risk-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 1.5rem 1rem;
      border-radius: 8px;
      text-align: center;
  }

  .risk-label {
      font-size: 0.85rem;
      color: #8392a5;
      margin-bottom: 0.5rem;
  }

  .risk-main-val {
      font-size: 1.4rem;
      font-weight: bold;
      color: #f0e68c; /* Theme Yellow */
      margin-bottom: 0.3rem;
  }

  .risk-sub-val {
      font-size: 0.8rem;
      color: #b0c4de;
  }

  /* åˆ†å¸ƒå›¾è¡¨ */
  .dist-table-inner {
      min-width: 600px;
  }

  .dist-header-row,
  .dist-bar-row,
  .dist-label-row {
      display: flex;
      width: 100%;
  }

  .dist-col {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      font-size: 0.8rem;
      color: #8392a5;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
  }
  .dist-col:last-child {
      border-right: none;
  }

  .dist-bar-row {
      height: 40px;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
  }

  .dist-block.yellow-theme {
      background: linear-gradient(145deg, #f0e68c, #d4c550); /* Yellow Gradient */
      color: #121212;
      font-weight: bold;
      padding: 0.3rem 0;
      border-radius: 4px;
  }

  .risk-table {
      min-width: 700px;
  }

  /* =========================================
                                                                                                                                                                                                                                                                                                                                     FAQ æ ·å¼
                                                                                                                                                                                                                                                                                                                                     ========================================= */
  .faq-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
  }

  .faq-item {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .faq-item:last-child {
      border-bottom: none;
  }

  .faq-question {
      width: 100%;
      text-align: left;
      padding: 1rem 0;
      background: none;
      border: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }

  .faq-icon {
      font-size: 1.5rem;
      font-weight: bold;
      transition: transform 0.3s ease;
      color: #f0e68c;
  }

  .faq-icon.is-open {
      transform: rotate(45deg);
  }

  .faq-answer {
      padding-bottom: 1rem;
      color: #b0c4de;
      line-height: 1.7;
  }

  @keyframes fadeInUp {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }
  /* =========================================
                                                                                                                                                                                                                                                   ç§»åŠ¨ç«¯é€‚é… (æœ€ç»ˆä¿®æ­£ç‰ˆ)
                                                                                                                                                                                                                                                   ========================================= */
  @media (max-width: 768px) {
      /* 1. æ ¸å¿ƒä¿®å¤ï¼šç»™æ‰€æœ‰æ»šåŠ¨å®¹å™¨æ·»åŠ æ¸å˜é®ç½©ï¼Œå¢åŠ é«˜çº§æ„Ÿ */
      .table-container,
      .table-wrapper,
      .heatmap-container {
          mask-image: linear-gradient(to right, transparent, black 15px, black 95%, transparent);
          -webkit-mask-image: linear-gradient(
              to right,
              transparent,
              black 15px,
              black 95%,
              transparent
          );
      }

      /* 2. é¡µé¢å®¹å™¨è°ƒæ•´ï¼šç¡®ä¿ä¸è¶…å‡ºå±å¹• */
      .page-wrapper {
          padding: 2rem 1rem;
          width: 100vw; /* å¼ºåˆ¶è§†å£å®½åº¦ */
          box-sizing: border-box;
          overflow-x: hidden;
      }

      .main-container {
          width: 100%;
      }

      /* 3. å¤´éƒ¨æ ‡é¢˜é€‚é… */
      .page-header {
          margin-bottom: 2rem;
      }

      .main-title {
          font-size: 2rem;
          gap: 0.8rem;
      }

      .subtitle {
          font-size: 0.95rem;
          padding: 0 1rem; /* å¢åŠ æ–‡å­—å†…è¾¹è·é˜²æ­¢è´´è¾¹ */
      }

      /* 4. å¡ç‰‡é—´è·ä¸æ’ç‰ˆ */
      .content-card {
          padding: 1.5rem 1rem;
      }

      /* 5. ä¿®å¤ï¼šå›¾è¡¨å¤´éƒ¨æ ‡é¢˜å’Œæ—¥æœŸç«–å‘æ’åˆ— */
      .card-header-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.8rem;
      }

      .period-badge {
          font-size: 0.75rem;
          align-self: flex-start; /* é å·¦å¯¹é½ */
      }

      /* 6. è°ƒä»“æŒ‡å¼•ï¼šå•åˆ—æ˜¾ç¤º */
      .adjustments-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
      }

      /* 7. ç»Ÿè®¡æ¡ï¼šæ”¹ä¸º2åˆ—ç½‘æ ¼ */
      .stats-bar {
          grid-template-columns: repeat(2, 1fr);
          padding: 1rem;
          gap: 1rem;
      }

      /* 8. é£é™©æ•°æ®ï¼šå•åˆ—æ˜¾ç¤º */
      .risk-summary-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
      }

      .risk-box {
          padding: 1.2rem;
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      /* 9. å­—ä½“ä¸ç»†èŠ‚å¾®è°ƒ */
      .faq-question {
          font-size: 0.95rem;
      }

      .data-table,
      .heatmap-table,
      .risk-table,
      .dist-table-inner {
          font-size: 0.85rem;
      }

      /* 10. ä¿®å¤å›æ’¤åˆ†å¸ƒè¡¨çš„å®¹å™¨è¾¹è· */
      .dist-table-container {
          margin-bottom: 0;
          overflow-x: auto;
      }
  }

  /* --- æ–°å¢ï¼šç´§å‡‘å‹è®¡ç®—å™¨å·¥å…·æ¡æ ·å¼ --- */
  .calculator-toolbar {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(240, 230, 140, 0.2);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
      flex-wrap: wrap;
      gap: 1rem;
  }

  .calc-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
  }

  /* è¾“å…¥æ¡†å®¹å™¨ */
  .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
  }

  .currency-symbol {
      position: absolute;
      left: 10px;
      color: #f0e68c;
      font-weight: bold;
      font-size: 1rem;
      z-index: 2;
  }

  /* è¾“å…¥æ¡†æ ·å¼ï¼šå˜çŸ­ã€å˜ç²¾è‡´ */
  .compact-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 0.5rem 0.5rem 0.5rem 1.8rem; /* å·¦è¾¹ç•™å‡º Â¥ ç¬¦å·çš„ä½ç½® */
      border-radius: 6px;
      font-size: 1rem;
      width: 140px; /* é™åˆ¶å®½åº¦ */
      outline: none;
      transition: all 0.3s;
  }

  .compact-input:focus {
      border-color: #f0e68c;
      background: rgba(0, 0, 0, 0.3);
  }

  .calc-btn-compact {
      background: #f0e68c;
      color: #121212;
      border: none;
      padding: 0.55rem 1rem;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
  }
  .calc-btn-compact:hover {
      opacity: 0.9;
  }

  /* è¡Œå†…æ‘˜è¦æ ·å¼ */
  .calc-summary-inline {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      /* background: rgba(255, 255, 255, 0.03); */
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
  }

  .summary-tag {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      line-height: 1.2;
  }

  .summary-tag .label {
      font-size: 0.7rem;
      color: #8392a5;
      margin-bottom: 2px;
  }

  .summary-tag .value {
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
  }

  .summary-tag .value.highlight {
      color: #f0e68c;
  }
  .summary-tag .value.warn {
      color: #ff5722;
  }

  /* è¡¨æ ¼è®¡ç®—åˆ—é«˜äº® */
  .calc-col-head {
      background: rgba(240, 230, 140, 0.15) !important;
      color: #f0e68c !important;
  }
  .calc-col-cell {
      background: rgba(240, 230, 140, 0.03);
  }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 600px) {
      .calculator-toolbar {
          flex-direction: column;
          align-items: stretch;
      }
      .compact-input {
          width: 100%;
      }
      .calc-summary-inline {
          justify-content: space-between;
      }
  }

  /* --- æ–°å¢æŒ‰é’®æ ·å¼ --- */
  .calc-btn-compact.outline {
      background: transparent;
      border: 1px solid #f0e68c;
      color: #f0e68c;
      margin-left: 0.5rem;
  }
  .calc-btn-compact.outline:hover {
      background: rgba(240, 230, 140, 0.1);
  }

  .action-text-btn {
      background: none;
      border: none;
      color: #00c497; /* Green */
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
  }

  /* --- è°ƒä»“åˆ—è¡¨å³ä¾§æ ·å¼ --- */
  .adj-right {
      display: flex;
      align-items: center;
      gap: 0.6rem;
  }
  .shares-badge {
      font-size: 0.8rem;
      color: #fff;
      font-weight: bold;
  }

  /* --- Modal å¼¹çª—æ ·å¼ --- */
  .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 999;
      display: flex;
      justify-content: center;
      align-items: center;
  }

  .modal-content {
      background: #1e1e1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      max-height: 80vh; /* é˜²æ­¢å¤ªé«˜ */
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      animation: fadeInUp 0.3s ease-out;
  }

  .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .modal-header h3 {
      margin: 0;
      color: #f0e68c;
      font-size: 1.2rem;
  }
  .close-icon {
      font-size: 1.5rem;
      cursor: pointer;
      color: #8392a5;
  }

  .modal-body {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
  }

  .holding-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
  }

  /* è¾“å…¥æ¡†ç»„ */
  .input-group {
      position: relative;
  }

  .modal-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 0.6rem;
      border-radius: 6px;
      font-size: 0.95rem;
      outline: none;
  }
  .modal-input:focus {
      border-color: #f0e68c;
  }
  .modal-input.code {
      width: 90px;
      text-align: center;
  }
  .modal-input.shares {
      width: 80px;
      text-align: center;
  }

  .stock-name-display {
      flex: 1;
      color: #b0c4de;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
  }

  .delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 0.5rem;
  }

  .add-row-btn {
      width: 100%;
      padding: 0.8rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      color: #8392a5;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.5rem;
  }
  .add-row-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
  }

  .modal-footer {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
  }

  .modal-btn {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
  }
  .modal-btn.cancel {
      background: transparent;
      color: #8392a5;
  }
  .modal-btn.save {
      background: #f0e68c;
      color: #121212;
  }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 480px) {
      .holding-row {
          gap: 0.3rem;
      }
      .modal-input.code {
          width: 70px;
          padding: 0.5rem 0.2rem;
          font-size: 0.85rem;
      }
      .modal-input.shares {
          width: 60px;
          padding: 0.5rem 0.2rem;
          font-size: 0.85rem;
      }
      .stock-name-display {
          font-size: 0.8rem;
      }

      /* è°ƒæ•´å·¥å…·æ æŒ‰é’®ï¼Œé˜²æ­¢æŒ¤å‹ */
      .calc-left {
          width: 100%;
          justify-content: space-between;
      }
      .compact-input {
          width: 100px; /* è¿›ä¸€æ­¥ç¼©å°è¾“å…¥æ¡† */
      }
  }

  /* --- å·¥å…·æ æ•´ä½“å®¹å™¨ --- */
  .calculator-toolbar {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(240, 230, 140, 0.2);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 1.5rem;

      /* æ ¸å¿ƒå¸ƒå±€ï¼šä¸¤ç«¯å¯¹é½ï¼Œå…è®¸æ¢è¡Œ */
      display: flex;
      justify-content: space-between;
      align-items: center; /* å‚ç›´å±…ä¸­ */
      flex-wrap: wrap;
      gap: 1rem;
  }

  /* --- å·¦ä¾§æ“ä½œåŒº --- */
  .calc-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      /* ç§»åŠ¨ç«¯å¦‚æœå¤ªçª„ï¼Œå·¦ä¾§ä¹Ÿä¸è¦å‹ç¼©å¤ªå‰å®³ */
      flex-shrink: 0;
  }

  /* --- å³ä¾§ç»„åˆåŒº (ç»Ÿè®¡ + æŒ‰é’®) --- */
  .calc-right-group {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      /* è®©å³ä¾§åœ¨ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ¢è¡Œæˆ–æ˜¯å æ»¡ä¸€è¡Œ */
      flex-wrap: wrap;
      justify-content: flex-end;
  }

  /* ç»Ÿè®¡æ•°æ®è¡Œ */
  .stats-row {
      display: flex;
      gap: 1.5rem;
  }

  .summary-tag {
      display: flex;
      flex-direction: column;
      align-items: flex-start; /* ä¿æŒå·¦å¯¹é½ */
      line-height: 1.2;
  }

  /* --- [æ–°å¢] å½•å…¥ç»“æœæŒ‰é’®æ ·å¼ --- */
  .apply-result-btn {
      background: rgba(0, 196, 151, 0.15); /* æ·¡ç»¿è‰²èƒŒæ™¯ */
      color: #00c497;
      border: 1px solid rgba(0, 196, 151, 0.3);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
      display: flex;
      align-items: center;
      gap: 4px;
  }
  .apply-result-btn:hover {
      background: rgba(0, 196, 151, 0.25);
      transform: translateY(-1px);
  }

  /* --- ç§»åŠ¨ç«¯é€‚é… (é‡ç‚¹) --- */
  @media (max-width: 700px) {
      .calculator-toolbar {
          /* ç§»åŠ¨ç«¯æ”¹ä¸ºçºµå‘æ’åˆ—ï¼Œå·¦ä¾§åœ¨ä¸Šï¼Œå³ä¾§åœ¨ä¸‹ */
          flex-direction: column;
          align-items: stretch; /* æ‹‰ä¼¸å¡«æ»¡å®½åº¦ */
          gap: 1.2rem;
      }

      .calc-left {
          width: 100%;
          justify-content: space-between; /* æŒ‰é’®å’Œè¾“å…¥æ¡†åˆ†æ•£å¯¹é½ */
      }

      /* è¾“å…¥æ¡†ç¨å¾®ç¼©çŸ­ä¸€ç‚¹ï¼Œç»™æŒ‰é’®ç•™ä½ç½® */
      .compact-input {
          width: 90px;
      }

      .calc-right-group {
          width: 100%;
          justify-content: space-between; /* ç»Ÿè®¡å’ŒæŒ‰é’®åˆ†æ•£å¯¹é½ */
          border-top: 1px solid rgba(255, 255, 255, 0.1); /* åŠ ä¸ªé¡¶éƒ¨åˆ†å‰²çº¿ */
          padding-top: 1rem;
      }

      .stats-row {
          gap: 1rem; /* ç¼©å°é—´è· */
      }
      .modal-content {
          width: 85%;
      }
  }

  /* é’ˆå¯¹è¶…å°å±å¹• (iPhone SE ç­‰) çš„å¾®è°ƒ */
  @media (max-width: 380px) {
      .calc-right-group {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
      }
      .apply-result-btn {
          width: 100%;
          justify-content: center;
      }
  }

  /* --- è°ƒä»“åˆ—è¡¨é¡¹å†…éƒ¨å¸ƒå±€ --- */
  .adjustment-item {
      /* ç¡®ä¿ Flex å¸ƒå±€ä¸¤ç«¯å¯¹é½ */
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* ...åŸæœ‰çš„èƒŒæ™¯è‰²ç­‰æ ·å¼ä¿æŒ... */
  }

  /* å·¦ä¾§ï¼šåå­—+ä»£ç  */
  .item-left {
      display: flex;
      align-items: baseline; /* åŸºçº¿å¯¹é½ï¼Œè®©æ–‡å­—åº•éƒ¨å¯¹é½ */
      gap: 6px; /* åå­—å’Œä»£ç çš„é—´è· */
      overflow: hidden; /* é˜²æ­¢è¿‡é•¿æº¢å‡º */
  }

  .stock-name {
      font-weight: 500;
      white-space: nowrap;
  }

  /* [æ–°å¢] è‚¡ç¥¨ä»£ç çš„å°å­—æ ·å¼ */
  .code-tiny {
      font-size: 0.8rem;
      color: #bec9d8; /* ç°è‰² */
      font-family: 'Roboto Mono', monospace; /* ç­‰å®½å­—ä½“æ›´åƒä»£ç  */
      opacity: 0.8;
  }

  /* ç§»åŠ¨ç«¯é€‚é…ï¼šå¦‚æœå±å¹•ç‰¹åˆ«å°ï¼Œå…è®¸åå­—å’Œä»£ç æ¢è¡Œï¼Œæˆ–è€…ç¼©å°é—´è· */
  @media (max-width: 360px) {
      .item-left {
          flex-direction: column; /* åå­—å’Œä»£ç ä¸Šä¸‹æ’åˆ— */
          align-items: flex-start;
          gap: 0;
      }
      .code-tiny {
          font-size: 0.75rem;
      }
  }
  /* --- ç¡®è®¤å¼¹çª—ä¸“ç”¨æ ·å¼ --- */
  .confirm-dialog {
      max-width: 360px; /* å°å·§ä¸€ç‚¹ */

      border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modal-header.no-border {
      border-bottom: none;
      padding-bottom: 0;
      justify-content: center;
      padding-top: 1.5rem;
  }

  .confirm-title {
      color: #fff; /* æ™®é€šç™½è‰²æ ‡é¢˜ */
      font-size: 1.2rem;
      margin: 0;
  }

  .modal-body.text-center {
      text-align: center;
      padding: 1rem 1.5rem;
  }

  .confirm-text {
      font-size: 1rem;
      color: #b0c4de;
      margin-bottom: 0.5rem;
      line-height: 1.6;
  }

  .confirm-text strong {
      color: #f0e68c; /* é‡ç‚¹æ–‡å­—ç”¨ä¸»é¢˜é»„é«˜äº® */
  }

  .confirm-subtext {
      font-size: 0.85rem;
      color: #909399; /* å¼±åŒ–è¾…åŠ©æ–‡å­— */
  }

  .modal-footer.center-footer {
      justify-content: center;
      border-top: none;
      padding-top: 0;
      padding-bottom: 1.5rem;
      gap: 1rem;
  }

  /* [ä¿®æ”¹] ç¡®è®¤æŒ‰é’®æ ·å¼ï¼šç”¨ä¸»é¢˜è‰²ï¼Œä¸ç”¨çº¢è‰² */
  .modal-btn.confirm-primary {
      background: #f0e68c;
      color: #121212;
      padding: 0.6rem 1.5rem;
  }
  .modal-btn.confirm-primary:hover {
      background: #d4c550;
  }

  /* ... åŸæœ‰çš„ .action-badge åŸºç¡€æ ·å¼ä¿æŒä¸å˜ ... */
  .action-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #fff;
      min-width: 3em; /* ä¿è¯å¾½æ ‡å®½åº¦ä¸€è‡´ */
      text-align: center;
  }

  /* åŸºç¡€å¾½æ ‡æ ·å¼ */
  .action-badge {
      padding: 0.25rem 0.5rem; /* ç¨å¾®è°ƒæ•´å†…è¾¹è· */
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #fff;
      text-align: center;
      display: inline-block;
      min-width: 4em; /* ç¨å¾®å®½ä¸€ç‚¹ä»¥å®¹çº³4ä¸ªå­— */
  }

  /* --- 1. å…¨æ–°ä¹°å…¥ (New Buy) - 4å­—ï¼Œè§†è§‰æœ€å¼º --- */
  .action-badge.new-buy {
      background-color: rgba(0, 196, 151, 0.6); /* äº®ç»¿å®å¿ƒ */
      box-shadow: 0 2px 6px rgba(0, 196, 151, 0.4); /* å‘å…‰æŠ•å½± */
      font-weight: 800; /* ç‰¹åˆ«åŠ ç²— */
      border: 1px solid rgba(0, 196, 151, 0.4);
  }

  /* --- 2. å¢æŒ (Add Buy) - 2å­—ï¼Œè§†è§‰ç¨å¼± --- */
  .action-badge.add-buy {
      background-color: transparent;
      color: #00c497;
      border: 1px solid rgba(0, 196, 151, 0.6);
  }

  /* --- 3. å…¨éƒ¨å–å‡º (Clear Sell) - 4å­—ï¼Œè§†è§‰æœ€å¼º --- */
  .action-badge.clear-sell {
      background-color: rgba(255, 87, 34, 0.6); /* äº®çº¢å®å¿ƒ */
      box-shadow: 0 2px 6px rgba(255, 87, 34, 0.4); /* å‘å…‰æŠ•å½± */
      font-weight: 800; /* ç‰¹åˆ«åŠ ç²— */
      border: 1px solid rgba(255, 87, 34, 0.4);
  }

  /* --- 4. å‡æŒ (Cut Sell) - 2å­—ï¼Œè§†è§‰ç¨å¼± --- */
  .action-badge.cut-sell {
      background-color: transparent;
      color: #ff5722;
      border: 1px solid rgba(255, 87, 34, 0.6);
  }

  /* ç§»åŠ¨ç«¯å¾®è°ƒï¼šé˜²æ­¢4ä¸ªå­—æŠŠå¸ƒå±€æŒ¤å */
  @media (max-width: 360px) {
      .action-badge {
          font-size: 0.75rem; /* å­—ä½“ç¨å¾®æ”¹å° */
          padding: 0.2rem 0.3rem;
      }
  }
</style>