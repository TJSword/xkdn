<template>
  <div class="page-wrapper">
    <div class="main-container">

      <!-- 1. é¡µé¢æ ‡é¢˜ -->
      <div class="page-header">
        <router-link to="/home" class="back-button">
          â† è¿”å›ä¸»é¡µ
        </router-link>

        <h1 class="main-title">
          <span class="title-icon">ğŸ§­</span>
          å¸‚åœºç½—ç›˜
        </h1>
        <p class="subtitle">
          ä»¥å®è§‚æ•°æ®ä¸ºé”šï¼Œç©¿è¶Šå¸‚åœºè¿·é›¾ã€‚
        </p>
      </div>

      <!-- 2. æŒ‡æ ‡å›¾è¡¨ç½‘æ ¼ -->
      <div class="content-grid">

        <!-- å¡ç‰‡1: å·´è²ç‰¹æŒ‡æ ‡ -->
        <div class="content-card">
          <h2 class="card-title">å·´è²ç‰¹æŒ‡æ ‡ (Aè‚¡æ€»å¸‚å€¼ / GDP)</h2>
          <p class="card-description">
            è¿™æ˜¯è¡¡é‡è‚¡å¸‚æ•´ä½“ä¼°å€¼æ°´å¹³çš„æ ¸å¿ƒæŒ‡æ ‡ä¹‹ä¸€ã€‚å½“æŒ‡æ ‡å€¼è¿œé«˜äºå†å²å‡å€¼æ—¶ï¼Œå¸‚åœºå¯èƒ½å¤„äºé«˜ä¼°åŒºåŸŸï¼Œé£é™©è¾ƒå¤§ï¼›åä¹‹åˆ™å¯èƒ½å¤„äºä½ä¼°åŒºåŸŸï¼Œå…·å¤‡é•¿æœŸæŠ•èµ„ä»·å€¼ã€‚
          </p>
          <div ref="buffettChartContainer" class="echart-container"></div>
        </div>

        <!-- å¡ç‰‡2: è‚¡å€ºåˆ©å·® (ERP) -->
        <div class="content-card">
          <h2 class="card-title">è‚¡å€ºåˆ©å·® (ä¸‡å¾—å…¨Aæ»šåŠ¨å¸‚ç›ˆç‡å€’æ•° - åå¹´æœŸå›½å€ºæ”¶ç›Šç‡)</h2>
          <p class="card-description">
            è¯¥æŒ‡æ ‡åæ˜ äº†æŠ•èµ„äºè‚¡å¸‚ç›¸å¯¹äºæ— é£é™©å›½å€ºçš„è¶…é¢å›æŠ¥é¢„æœŸã€‚åˆ©å·®è¶Šé«˜ï¼Œæ„å‘³ç€è‚¡ç¥¨ç›¸å¯¹äºå€ºåˆ¸è¶Šä¾¿å®œï¼Œå¸å¼•åŠ›è¶Šå¤§ï¼›åˆ©å·®è¶Šä½ï¼Œåˆ™è‚¡ç¥¨è¶Šè´µã€‚
          </p>
          <div ref="erpChartContainer" class="echart-container"></div>
        </div>

        <!-- å¡ç‰‡3: è¡Œä¸šæ‹¥æŒ¤åº¦ -->
        <div class="content-card">
          <h2 class="card-title">è¡Œä¸šæ‹¥æŒ¤åº¦</h2>
          <p class="card-description">
            é€šè¿‡åˆ†æç‰¹å®šè¡Œä¸šæˆäº¤é¢å å…¨å¸‚åœºæ€»æˆäº¤é¢çš„æ¯”ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿèµ„é‡‘çš„æµå‘ã€‚å½“æŸä¸ªè¡Œä¸šçš„æ‹¥æŒ¤åº¦æŒç»­å¤„äºé«˜ä½æ—¶ï¼Œå¯èƒ½æ„å‘³ç€æƒ…ç»ªè¿‡çƒ­ï¼Œå­˜åœ¨çŸ­æœŸå›è°ƒé£é™©ã€‚
          </p>
          <div ref="crowdingChartContainer" class="echart-container"></div>
        </div>

        <!-- å¡ç‰‡4: è¡Œä¸šæ™¯æ°”åº¦/ä¼°å€¼ -->
        <div class="content-card">
          <h2 class="card-title">è¡Œä¸šä¼°å€¼æ¸©åº¦</h2>
          <p class="card-description">
            æ­¤å›¾è¡¨å±•ç¤ºäº†å½“å‰å„ä¸»æµè¡Œä¸šçš„å¸‚ç›ˆç‡ï¼ˆPE-TTMï¼‰åœ¨å…¶è¿‡å»åå¹´å†å²ä¼°å€¼ä¸­æ‰€å¤„çš„ä½ç½®ã€‚æ¸©åº¦è¶Šâ€œå†·â€ï¼Œä»£è¡¨ä¼°å€¼è¶Šä½ï¼Œè¶Šæ¥è¿‘å†å²åº•éƒ¨ï¼›æ¸©åº¦è¶Šâ€œçƒ­â€ï¼Œåˆ™ä»£è¡¨ä¼°å€¼è¶Šé«˜ã€‚
          </p>
          <div ref="valuationChartContainer" class="echart-container"></div>
        </div>

      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { ref, onMounted, onUnmounted } from 'vue'
  import * as echarts from 'echarts'

  // --- Refs for ECharts containers ---
  const buffettChartContainer = ref<HTMLElement | null>(null)
  const erpChartContainer = ref<HTMLElement | null>(null)
  const crowdingChartContainer = ref<HTMLElement | null>(null)
  const valuationChartContainer = ref<HTMLElement | null>(null)

  // --- ECharts instances ---
  let buffettChart: echarts.ECharts | null = null
  let erpChart: echarts.ECharts | null = null
  let crowdingChart: echarts.ECharts | null = null
  let valuationChart: echarts.ECharts | null = null

  const allCharts: (echarts.ECharts | null)[] = []

  // --- Chart Initialization Functions ---

  /**
   * åˆå§‹åŒ–å·´è²ç‰¹æŒ‡æ ‡å›¾è¡¨
   */
  const initBuffettChart = () => {
      if (buffettChartContainer.value) {
          buffettChart = echarts.init(buffettChartContainer.value, 'dark')
          allCharts.push(buffettChart)

          // TODO: æœªæ¥ç”¨APIè·å–çœŸå®æ•°æ®æ›¿æ¢è¿™é‡Œçš„æ¨¡æ‹Ÿæ•°æ®
          const mockData = {
              dates: [
                  '2022-01',
                  '2022-04',
                  '2022-07',
                  '2022-10',
                  '2023-01',
                  '2023-04',
                  '2023-07',
                  '2023-10',
                  '2024-01',
                  '2024-04'
              ],
              values: [95, 82, 88, 79, 90, 85, 92, 80, 75, 83]
          }

          const option: echarts.EChartsOption = {
              backgroundColor: 'transparent',
              tooltip: { trigger: 'axis', formatter: '{b}<br/>æŒ‡æ ‡å€¼: {c}%' },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'category', boundaryGap: false, data: mockData.dates },
              yAxis: { type: 'value', axisLabel: { formatter: '{value}%' } },
              series: [
                  {
                      name: 'å·´è²ç‰¹æŒ‡æ ‡',
                      type: 'line',
                      smooth: true,
                      data: mockData.values,
                      itemStyle: { color: '#00aaff' },
                      areaStyle: {
                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                              { offset: 0, color: 'rgba(0, 170, 255, 0.3)' },
                              { offset: 1, color: 'rgba(0, 170, 255, 0)' }
                          ])
                      },
                      markLine: {
                          silent: true,
                          data: [
                              {
                                  yAxis: 100,
                                  name: 'é«˜ä¼°è­¦ç¤ºçº¿',
                                  label: { formatter: 'é«˜ä¼°è­¦ç¤ºçº¿: {c}%', position: 'end' },
                                  lineStyle: { color: '#ff6b6b' }
                              },
                              {
                                  yAxis: 70,
                                  name: 'ä½ä¼°æœºä¼šçº¿',
                                  label: { formatter: 'ä½ä¼°æœºä¼šçº¿: {c}%' },
                                  lineStyle: { color: '#28a745' }
                              }
                          ]
                      }
                  }
              ]
          }
          buffettChart.setOption(option)
      }
  }

  /**
   * åˆå§‹åŒ–è‚¡å€ºåˆ©å·®å›¾è¡¨
   */
  const initErpChart = () => {
      if (erpChartContainer.value) {
          erpChart = echarts.init(erpChartContainer.value, 'dark')
          allCharts.push(erpChart)

          const mockData = {
              dates: [
                  '2022-01',
                  '2022-04',
                  '2022-07',
                  '2022-10',
                  '2023-01',
                  '2023-04',
                  '2023-07',
                  '2023-10',
                  '2024-01',
                  '2024-04'
              ],
              values: [1.8, 2.5, 2.2, 2.8, 2.1, 2.4, 1.9, 2.9, 3.2, 2.6]
          }

          const option: echarts.EChartsOption = {
              backgroundColor: 'transparent',
              tooltip: { trigger: 'axis', formatter: '{b}<br/>è‚¡å€ºåˆ©å·®: {c}%' },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'category', boundaryGap: false, data: mockData.dates },
              yAxis: { type: 'value', axisLabel: { formatter: '{value}%' } },
              series: [
                  {
                      name: 'è‚¡å€ºåˆ©å·®',
                      type: 'line',
                      smooth: true,
                      data: mockData.values,
                      itemStyle: { color: '#39cccc' },
                      areaStyle: {
                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                              { offset: 0, color: 'rgba(57, 204, 204, 0.3)' },
                              { offset: 1, color: 'rgba(57, 204, 204, 0)' }
                          ])
                      },
                      markLine: {
                          silent: true,
                          data: [{ type: 'average', name: 'å†å²å‡å€¼' }]
                      }
                  }
              ]
          }
          erpChart.setOption(option)
      }
  }

  /**
   * åˆå§‹åŒ–è¡Œä¸šæ‹¥æŒ¤åº¦å›¾è¡¨
   */
  const initCrowdingChart = () => {
      if (crowdingChartContainer.value) {
          crowdingChart = echarts.init(crowdingChartContainer.value, 'dark')
          allCharts.push(crowdingChart)

          const mockData = {
              sectors: ['åŠå¯¼ä½“', 'æ–°èƒ½æº', 'ç™½é…’', 'åŒ»è¯', 'é“¶è¡Œ', 'AI', 'ç…¤ç‚­'],
              values: [18, 15, 8, 11, 5, 22, 4]
          }

          const option: echarts.EChartsOption = {
              backgroundColor: 'transparent',
              tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: {
                  type: 'category',
                  data: mockData.sectors,
                  axisLabel: { interval: 0, rotate: 30 }
              },
              yAxis: { type: 'value', axisLabel: { formatter: '{value}%' } },
              series: [
                  {
                      name: 'æˆäº¤é¢å æ¯”',
                      type: 'bar',
                      barWidth: '60%',
                      data: mockData.values,
                      itemStyle: {
                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                              { offset: 0, color: '#83bff6' },
                              { offset: 0.5, color: '#188df0' },
                              { offset: 1, color: '#188df0' }
                          ])
                      }
                  }
              ]
          }
          crowdingChart.setOption(option)
      }
  }

  /**
   * åˆå§‹åŒ–è¡Œä¸šä¼°å€¼å›¾è¡¨
   */
  const initValuationChart = () => {
      if (valuationChartContainer.value) {
          valuationChart = echarts.init(valuationChartContainer.value, 'dark')
          allCharts.push(valuationChart)

          // æ¨¡æ‹Ÿæ•°æ®ï¼šè¡Œä¸šåç§° å’Œ å…¶åœ¨å†å²ä¼°å€¼ä¸­çš„ç™¾åˆ†ä½ (0-100)
          const mockData = [
              { name: 'é“¶è¡Œ', value: 8 },
              { name: 'ç…¤ç‚­', value: 25 },
              { name: 'åŒ»è¯ç”Ÿç‰©', value: 35 },
              { name: 'é£Ÿå“é¥®æ–™', value: 55 },
              { name: 'ç”µåŠ›è®¾å¤‡', value: 72 },
              { name: 'ç”µå­', value: 88 },
              { name: 'é€šä¿¡', value: 95 }
          ].sort((a, b) => a.value - b.value) // æŒ‰ä¼°å€¼ä»ä½åˆ°é«˜æ’åº

          const option: echarts.EChartsOption = {
              backgroundColor: 'transparent',
              tooltip: {
                  trigger: 'axis',
                  axisPointer: { type: 'shadow' },
                  formatter: (params: any) =>
                      `${params[0].name}<br/>å†å²åˆ†ä½ç‚¹: <strong>${params[0].value}%</strong>`
              },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'value', boundaryGap: [0, 0.01], show: false },
              yAxis: {
                  type: 'category',
                  data: mockData.map(item => item.name),
                  axisTick: { show: false },
                  axisLine: { show: false }
              },
              series: [
                  {
                      name: 'ä¼°å€¼æ¸©åº¦',
                      type: 'bar',
                      data: mockData.map(item => ({
                          value: item.value,
                          itemStyle: {
                              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                  { offset: 0, color: '#28a745' }, // å†·è‰² (ä½ä¼°)
                                  { offset: 0.5, color: '#ffc107' }, // ä¸­æ€§
                                  { offset: 1, color: '#ff6b6b' } // çƒ­è‰² (é«˜ä¼°)
                              ])
                          }
                      })),
                      label: {
                          show: true,
                          position: 'right',
                          formatter: '{c}%',
                          color: '#fff',
                          fontWeight: 'bold'
                      }
                  }
              ]
          }
          valuationChart.setOption(option)
      }
  }

  // --- Lifecycle Hooks ---

  onMounted(() => {
      // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
      initBuffettChart()
      initErpChart()
      initCrowdingChart()
      initValuationChart()

      // æ·»åŠ çª—å£å¤§å°è°ƒæ•´çš„ç›‘å¬å™¨
      window.addEventListener('resize', handleResize)
  })

  onUnmounted(() => {
      // ç§»é™¤ç›‘å¬å™¨å¹¶é”€æ¯å›¾è¡¨å®ä¾‹
      window.removeEventListener('resize', handleResize)
      allCharts.forEach(chart => chart?.dispose())
  })

  // --- Utility Functions ---

  const handleResize = () => {
      allCharts.forEach(chart => chart?.resize())
  }
</script>

<style scoped>
  /* è¿™é‡Œçš„æ ·å¼å¾ˆå¤§ç¨‹åº¦ä¸Šå¤ç”¨äº†æ‚¨æä¾›çš„ AllWeatherStrategy.vue çš„æ ·å¼ï¼Œä»¥ç¡®ä¿é£æ ¼ç»Ÿä¸€ */
  /* å”¯ä¸€çš„å¾®å°æ”¹åŠ¨æ˜¯ .title-icon çš„æ ·å¼ï¼Œä½¿å…¶æ›´çªå‡º */

  @keyframes fadeInUp {
      from {
          opacity: 0;
          transform: translateY(20px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  .page-wrapper {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #121212;
      color: #ffffff;
      min-height: 100vh;
      padding: 3rem 1rem;
      /* --- REPLACE THE LINE BELOW --- */
      background: radial-gradient(circle at 15% 50%, #1a4a4a, transparent 40%),
          radial-gradient(circle at 85% 50%, #1f6666, transparent 40%), #121212;
  }

  .main-container {
      max-width: 1200px; /* å…è®¸æ›´å®½çš„å¸ƒå±€ä»¥å®¹çº³å¹¶æ’å›¾è¡¨ */
      margin: 0 auto;
  }

  .page-header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInUp 0.5s ease-out forwards;
      opacity: 0;
  }

  .back-button {
      color: #b0c4de;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.3s ease;
      display: inline-block;
      margin-bottom: 1rem;
  }
  .back-button:hover {
      color: #00aaff;
  }

  .main-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
  }
  .title-icon {
      font-size: 2.8rem;
      text-shadow: 0 0 15px rgba(57, 204, 204, 0.7); /* ä½¿ç”¨é’è‰²å…‰æ™•åŒ¹é…æ–°å¡ç‰‡é¢œè‰² */
  }
  .subtitle {
      font-size: 1.1rem;
      color: #b0c4de;
  }

  .content-grid {
      display: grid;
      /* æ¯è¡Œæ˜¾ç¤ºä¸¤ä¸ªå›¾è¡¨å¡ç‰‡ */
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
  }

  .content-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem 2rem;
      backdrop-filter: blur(10px);
      transition: border-color 0.3s ease;
      animation: fadeInUp 0.5s ease-out forwards;
      opacity: 0;
      display: flex;
      flex-direction: column;
  }
  .content-card:hover {
      border-color: rgba(57, 204, 204, 0.5); /* æ‚¬åœæ—¶ä½¿ç”¨é’è‰²è¾¹æ¡† */
  }

  /* äº¤é”™åŠ è½½åŠ¨ç”» */
  .content-card:nth-child(1) {
      animation-delay: 0.2s;
  }
  .content-card:nth-child(2) {
      animation-delay: 0.3s;
  }
  .content-card:nth-child(3) {
      animation-delay: 0.4s;
  }
  .content-card:nth-child(4) {
      animation-delay: 0.5s;
  }

  .card-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #ffffff;
      margin-top: 0;
      margin-bottom: 1rem;
      border-left: 4px solid #39cccc; /* ä½¿ç”¨é’è‰²ä½œä¸ºå¼ºè°ƒè‰² */
      padding-left: 1rem;
  }

  .card-description {
      font-size: 0.95rem;
      color: #b0c4de;
      line-height: 1.7;
      margin-bottom: 1.5rem; /* å¢åŠ ä¸å›¾è¡¨çš„é—´è· */
  }

  .echart-container {
      width: 100%;
      height: 300px; /* ç»Ÿä¸€å›¾è¡¨é«˜åº¦ */
      flex-grow: 1; /* è®©å›¾è¡¨å®¹å™¨å¡«æ»¡å¡ç‰‡å‰©ä½™ç©ºé—´ */
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 992px) {
      .content-grid {
          /* åœ¨å¹³æ¿å’Œæ‰‹æœºä¸Šï¼Œæ¯è¡Œåªæ˜¾ç¤ºä¸€ä¸ªå›¾è¡¨ */
          grid-template-columns: 1fr;
      }
      .main-container {
          max-width: 700px;
      }
  }

  @media (max-width: 768px) {
      .page-wrapper {
          padding: 2rem 1rem;
      }
      .main-title {
          font-size: 2rem;
      }
      .subtitle {
          font-size: 1rem;
      }
      .content-card {
          padding: 1.2rem;
      }
      .card-title {
          font-size: 1.25rem;
      }
  }
</style>